THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){var ie,oe,i,ae,se,le,ce,pe,Ee,de,ue,he=[],fe=0,me=[],r=0,t=[],n=0,o=[],a=0,ve=[],Re=0,xe={objects:[],lights:[],elements:[]},ye=new THREE.Vector3,Te=new THREE.Vector4,f=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),m=new THREE.Box3,s=new Array(3),He=(new Array(4),new THREE.Matrix4),we=new THREE.Matrix4,ge=new THREE.Matrix4,be=new THREE.Matrix3,Me=new THREE.Frustum,Se=new THREE.Vector4,ze=new THREE.Vector4,Ve=(this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(r)},this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(r)},this.pickingRay=function(e,r){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")},new function(){var l=[],c=[],p=null,E=null,d=new THREE.Matrix3;function n(e){var r=e.position,t=e.positionWorld,n=e.positionScreen,r=(t.copy(r).applyMatrix4(ue),n.copy(t).applyMatrix4(we),1/n.w);n.x*=r,n.y*=r,n.z*=r,e.visible=-1<=n.x&&n.x<=1&&-1<=n.y&&n.y<=1&&-1<=n.z&&n.z<=1}function u(e,r,t){return!0===e.visible||!0===r.visible||!0===t.visible||(s[0]=e.positionScreen,s[1]=r.positionScreen,s[2]=t.positionScreen,f.intersectsBox(m.setFromPoints(s)))}function h(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(e){E=(p=e).material,d.getNormalMatrix(p.matrixWorld),l.length=0,c.length=0},projectVertex:n,checkTriangleVisibility:u,checkBackfaceCulling:h,pushVertex:function(e,r,t){(i=je()).position.set(e,r,t),n(i)},pushNormal:function(e,r,t){l.push(e,r,t)},pushUv:function(e,r){c.push(e,r)},pushLine:function(e,r){e=me[e],r=me[r],(ce=Ce()).id=p.id,ce.v1.copy(e),ce.v2.copy(r),ce.z=(e.positionScreen.z+r.positionScreen.z)/2,ce.renderOrder=p.renderOrder,ce.material=p.material,xe.elements.push(ce)},pushTriangle:function(e,r,t){var n=me[e],i=me[r],o=me[t];if(!1!==u(n,i,o)&&(E.side===THREE.DoubleSide||!0===h(n,i,o))){(se=Oe()).id=p.id,se.v1.copy(n),se.v2.copy(i),se.v3.copy(o),se.z=(n.positionScreen.z+i.positionScreen.z+o.positionScreen.z)/3,se.renderOrder=p.renderOrder,se.normalModel.fromArray(l,3*e),se.normalModel.applyMatrix3(d).normalize();for(var a=0;a<3;a++){var s=se.vertexNormalsModel[a];s.fromArray(l,3*arguments[a]),s.applyMatrix3(d).normalize(),se.uvs[a].fromArray(c,2*arguments[a])}se.vertexNormalsLength=3,se.material=p.material,xe.elements.push(se)}}}});function je(){var e;return ae===r?(e=new THREE.RenderableVertex,me.push(e),r++,ae++,e):me[ae++]}function Oe(){var e;return le===n?(e=new THREE.RenderableFace,t.push(e),n++,le++,e):t[le++]}function Ce(){var e;return pe===a?(e=new THREE.RenderableLine,o.push(e),a++,pe++,e):o[pe++]}function Le(e,r){return e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id!==r.id?e.id-r.id:0}this.projectScene=function(e,r,W,B){function F(e){(ie=function(){if(oe!==fe)return he[oe++];var e=new THREE.RenderableObject;return he.push(e),fe++,oe++,e}()).id=e.id,ie.object=e,ye.setFromMatrixPosition(e.matrixWorld),ye.applyMatrix4(we),ie.z=ye.z,ie.renderOrder=e.renderOrder,xe.objects.push(ie)}de=pe=le=0,!(xe.elements.length=0)===e.autoUpdate&&e.updateMatrixWorld(),null===r.parent&&r.updateMatrixWorld(),He.copy(r.matrixWorldInverse.getInverse(r.matrixWorld)),we.multiplyMatrices(r.projectionMatrix,He),Me.setFromMatrix(we),oe=0,xe.objects.length=0,xe.lights.length=0,e.traverseVisible(function(e){e instanceof THREE.Light?xe.lights.push(e):e instanceof THREE.Mesh||e instanceof THREE.Line?!1===e.material.visible||!0===e.frustumCulled&&!1===Me.intersectsObject(e)||F(e):e instanceof THREE.Sprite&&(!1===e.material.visible||!0===e.frustumCulled&&!1===Me.intersectsSprite(e)||F(e))}),!0===W&&xe.objects.sort(Le);for(var t,n,i,o,a,s,l,c,p=0,P=xe.objects.length;p<P;p++){var E,d=xe.objects[p].object,u=d.geometry;if(Ve.setObject(d),ue=d.matrixWorld,ae=0,d instanceof THREE.Mesh){if(u instanceof THREE.BufferGeometry){var h=u.attributes,A=u.groups;if(void 0!==h.position){for(var f=0,m=(N=h.position.array).length;f<m;f+=3)Ve.pushVertex(N[f],N[f+1],N[f+2]);if(void 0!==h.normal)for(var v=h.normal.array,f=0,m=v.length;f<m;f+=3)Ve.pushNormal(v[f],v[f+1],v[f+2]);if(void 0!==h.uv)for(var D=h.uv.array,f=0,m=D.length;f<m;f+=2)Ve.pushUv(D[f],D[f+1]);if(null!==u.index){var R=u.index.array;if(0<A.length)for(var G=0;G<A.length;G++)for(var I=A[G],f=I.start,m=I.start+I.count;f<m;f+=3)Ve.pushTriangle(R[f],R[f+1],R[f+2]);else for(f=0,m=R.length;f<m;f+=3)Ve.pushTriangle(R[f],R[f+1],R[f+2])}else for(f=0,m=N.length/3;f<m;f+=3)Ve.pushTriangle(f,f+1,f+2)}}else if(u instanceof THREE.Geometry){var x=u.vertices,U=u.faces,q=u.faceVertexUvs[0];be.getNormalMatrix(ue);for(var J=(S=d.material)instanceof THREE.MultiMaterial,K=!0==J?d.material:null,y=0,Q=x.length;y<Q;y++){var T=x[y];if(ye.copy(T),!0===S.morphTargets)for(var X=u.morphTargets,Y=d.morphTargetInfluences,H=0,Z=X.length;H<Z;H++){var w,g=Y[H];0!==g&&(w=X[H].vertices[y],ye.x+=(w.x-T.x)*g,ye.y+=(w.y-T.y)*g,ye.z+=(w.z-T.z)*g)}Ve.pushVertex(ye.x,ye.y,ye.z)}for(var b=0,$=U.length;b<$;b++){var M=U[b],S=!0==J?K.materials[M.materialIndex]:d.material;if(void 0!==S){var z=S.side,V=me[M.a],j=me[M.b],O=me[M.c];if(!1!==Ve.checkTriangleVisibility(V,j,O)){var C=Ve.checkBackfaceCulling(V,j,O);if(z!==THREE.DoubleSide){if(z===THREE.FrontSide&&!1===C)continue;if(z===THREE.BackSide&&!0===C)continue}(se=Oe()).id=d.id,se.v1.copy(V),se.v2.copy(j),se.v3.copy(O),se.normalModel.copy(M.normal),!1!==C||z!==THREE.BackSide&&z!==THREE.DoubleSide||se.normalModel.negate(),se.normalModel.applyMatrix3(be).normalize();for(var _=M.vertexNormals,L=0,ee=Math.min(_.length,3);L<ee;L++){var re=se.vertexNormalsModel[L];re.copy(_[L]),!1!==C||z!==THREE.BackSide&&z!==THREE.DoubleSide||re.negate(),re.applyMatrix3(be).normalize()}se.vertexNormalsLength=_.length;var te=q[b];if(void 0!==te)for(var k=0;k<3;k++)se.uvs[k].copy(te[k]);se.color=M.color,se.material=S,se.z=(V.positionScreen.z+j.positionScreen.z+O.positionScreen.z)/3,se.renderOrder=d.renderOrder,xe.elements.push(se)}}}}}else if(d instanceof THREE.Line){if(u instanceof THREE.BufferGeometry){if(void 0!==(h=u.attributes).position){for(var N,f=0,m=(N=h.position.array).length;f<m;f+=3)Ve.pushVertex(N[f],N[f+1],N[f+2]);if(null!==u.index)for(f=0,m=(R=u.index.array).length;f<m;f+=2)Ve.pushLine(R[f],R[f+1]);else for(var ne=d instanceof THREE.LineSegments?2:1,f=0,m=N.length/3-1;f<m;f+=ne)Ve.pushLine(f,f+1)}}else if(u instanceof THREE.Geometry){ge.multiplyMatrices(we,ue);x=d.geometry.vertices;if(0!==x.length){(V=je()).positionScreen.copy(x[0]).applyMatrix4(ge);for(ne=d instanceof THREE.LineSegments?2:1,y=1,Q=x.length;y<Q;y++)(V=je()).positionScreen.copy(x[y]).applyMatrix4(ge),0<(y+1)%ne||(j=me[ae-2],Se.copy(V.positionScreen),ze.copy(j.positionScreen),!0==(n=ze,c=l=s=a=o=i=void 0,i=0,o=1,a=(t=Se).z+t.w,s=n.z+n.w,l=-t.z+t.w,c=-n.z+n.w,0<=a&&0<=s&&0<=l&&0<=c||!(a<0&&s<0||l<0&&c<0)&&(a<0?i=Math.max(i,a/(a-s)):s<0&&(o=Math.min(o,a/(a-s))),l<0?i=Math.max(i,l/(l-c)):c<0&&(o=Math.min(o,l/(l-c))),!(o<i)&&(t.lerp(n,i),n.lerp(t,1-o),!0)))&&(Se.multiplyScalar(1/Se.w),ze.multiplyScalar(1/ze.w),(ce=Ce()).id=d.id,ce.v1.positionScreen.copy(Se),ce.v2.positionScreen.copy(ze),ce.z=Math.max(Se.z,ze.z),ce.renderOrder=d.renderOrder,ce.material=d.material,d.material.vertexColors===THREE.VertexColors&&(ce.vertexColors[0].copy(d.geometry.colors[y]),ce.vertexColors[1].copy(d.geometry.colors[y-1])),xe.elements.push(ce)))}}}else d instanceof THREE.Sprite&&(Te.set(ue.elements[12],ue.elements[13],ue.elements[14],1),Te.applyMatrix4(we),E=1/Te.w,Te.z*=E,-1<=Te.z&&Te.z<=1&&((Ee=function(){if(de!==Re)return ve[de++];var e=new THREE.RenderableSprite;return ve.push(e),Re++,de++,e}()).id=d.id,Ee.x=Te.x*E,Ee.y=Te.y*E,Ee.z=Te.z,Ee.renderOrder=d.renderOrder,Ee.object=d,Ee.rotation=d.rotation,Ee.scale.x=d.scale.x*Math.abs(Ee.x-(Te.x+r.projectionMatrix.elements[0])/(Te.w+r.projectionMatrix.elements[12])),Ee.scale.y=d.scale.y*Math.abs(Ee.y-(Te.y+r.projectionMatrix.elements[5])/(Te.w+r.projectionMatrix.elements[13])),Ee.material=d.material,xe.elements.push(Ee)))}return!0===B&&xe.elements.sort(Le),xe}};